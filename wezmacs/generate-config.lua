#!/usr/bin/env lua
--[[
  WezMacs Config Generator

  Generates user configuration files in the new format:
  - modules.lua: List of modules to load (string or table format)
  - config.lua: Global settings (theme, fonts, mod_key, config_builder, setup)

  Usage:
    lua wezmacs/generate-config.lua [output_directory]

  Output directory defaults to ~/.config/wezmacs/
]]

local function get_home_dir()
  return os.getenv("HOME") or os.getenv("USERPROFILE")
end

local function get_config_dir()
  local xdg_config = os.getenv("XDG_CONFIG_HOME")
  if xdg_config then
    return xdg_config .. "/wezmacs"
  end
  return get_home_dir() .. "/.config/wezmacs"
end

local function get_wezmacs_dir()
  -- Get directory containing this script (wezmacs/generate-config.lua)
  local script_path = arg[0]
  local script_dir
  
  -- Handle both absolute and relative paths
  if script_path:match("^/") then
    -- Absolute path
    script_dir = script_path:match("^(.+)/[^/]+$")
  else
    -- Relative path - resolve from current working directory
    local cwd = io.popen("pwd"):read("*l")
    if script_path:match("^wezmacs/") then
      -- Script path is relative like "wezmacs/generate-config.lua"
      script_dir = cwd .. "/wezmacs"
    else
      -- Script path is just filename, assume wezmacs/ directory
      script_dir = cwd .. "/wezmacs"
    end
  end
  
  return script_dir
end

local function scan_modules()
  local modules = {}
  local wezmacs_dir = get_wezmacs_dir()
  local modules_dir = wezmacs_dir .. "/modules"

  -- Use ls to get module directories (each module is now a directory with init.lua)
  local handle = io.popen("ls -1 '" .. modules_dir .. "' 2>/dev/null")
  if not handle then
    error("Failed to list modules directory: " .. modules_dir)
  end

  for dir_name in handle:lines() do
    -- Skip if not a directory or if it's a special file
    local module_init_path = modules_dir .. "/" .. dir_name .. "/init.lua"
    local f = io.open(module_init_path, "r")
    if f then
      local content = f:read("*all")
      f:close()
      
      -- Extract module name, description, and category from the spec table
      -- Look for patterns like: name = "git", description = "...", category = "..."
      local name_match = content:match('name%s*=%s*["\']([^"\']+)["\']') or dir_name
      local desc_match = content:match('description%s*=%s*["\']([^"\']+)["\']') or ""
      local cat_match = content:match('category%s*=%s*["\']([^"\']+)["\']') or "integration"
      
      local module_info = {
        name = name_match,
        description = desc_match,
        category = cat_match,
      }
      
      table.insert(modules, module_info)
    end
  end

  handle:close()

  -- Sort modules by name
  table.sort(modules, function(a, b)
    return a.name < b.name
  end)

  return modules
end

local function generate_modules_lua(modules)
  local lines = {
    "--[[",
    "  WezMacs Modules Configuration",
    "",
    "  This file lists which modules to load.",
    "  Each entry can be:",
    "    - A string: \"module-name\" (enables module with default options)",
    "    - A table: { \"module-name\", opts = { ... }, keys = { ... } }",
    "",
    "  Examples:",
    "    \"term\"  -- Enable term module",
    "    { \"git\", opts = { leader_key = \"G\" } }  -- Enable git with custom options",
    "    { \"agent\", keys = { LEADER = { a = { action = ..., desc = \"...\" } } } }  -- Override keys",
    "",
    "  Generated by: wezmacs/generate-config.lua",
    "]]",
    "",
    "return {",
  }
  
  -- Add all modules as strings (simple enable)
  for _, mod in ipairs(modules) do
    table.insert(lines, '  "' .. mod.name .. '",')
  end
  
  table.insert(lines, "}")
  table.insert(lines, "")
  
  return table.concat(lines, "\n")
end

local function generate_config_lua()
  local lines = {
    "--[[",
    "  WezMacs Global Configuration",
    "",
    "  This file contains global WezMacs settings.",
    "  These values override defaults from wezmacs/config.lua",
    "",
    "  Available settings:",
    "    color_scheme - Color scheme name (string, nil for default)",
    "    mod_key - Modifier key (\"CMD\", \"ALT\", \"CTRL\", \"SHIFT\")",
    "    leader_key - Leader key (string, e.g., \"Space\")",
    "    leader_mod - Leader modifier (\"CMD\", \"ALT\", \"CTRL\", \"SHIFT\")",
    "    shell - Shell path (string, defaults to $SHELL or /bin/bash)",
    "",
    "  Modules can access these via:",
    "    local wezmacs = require('wezmacs')",
    "    print(wezmacs.config.color_scheme)",
    "",
    "  Generated by: wezmacs/generate-config.lua",
    "]]",
    "",
    "return {",
    "  -- color_scheme = nil,  -- nil = use WezTerm default",
    "  -- mod_key = \"CMD\",",
    "  -- leader_key = \"Space\",",
    "  -- leader_mod = \"CTRL\",",
    "  -- shell = nil,  -- nil = use $SHELL or /bin/bash",
    "}",
    "",
  }

  return table.concat(lines, "\n")
end

local function main()
  local output_dir = arg[1]
  if not output_dir then
    output_dir = get_config_dir()
  end

  -- Ensure output_dir ends without trailing slash
  output_dir = output_dir:gsub("/+$", "")

  print("Scanning modules...")
  local modules = scan_modules()
  print("Found " .. #modules .. " modules")

  print("Generating configuration files in: " .. output_dir)
  
  -- Create directory if needed
  os.execute("mkdir -p '" .. output_dir .. "'")

  -- Generate modules.lua
  local modules_content = generate_modules_lua(modules)
  local modules_path = output_dir .. "/modules.lua"
  local f = io.open(modules_path, "w")
  if not f then
    error("Failed to open output file: " .. modules_path)
  end
  f:write(modules_content)
  f:close()
  print("  ✓ Generated " .. modules_path)

  -- Generate config.lua
  local config_content = generate_config_lua()
  local config_path = output_dir .. "/config.lua"
  f = io.open(config_path, "w")
  if not f then
    error("Failed to open output file: " .. config_path)
  end
  f:write(config_content)
  f:close()
  print("  ✓ Generated " .. config_path)

  print("")
  print("✓ Configuration files generated successfully")
  print("")
  print("Next steps:")
  print("1. Edit " .. output_dir .. "/modules.lua to enable/configure modules")
  print("2. Edit " .. output_dir .. "/config.lua for global settings")
  print("3. Copy example/wezterm.lua to ~/.config/wezterm/wezterm.lua")
  print("4. Reload WezTerm (Cmd+Option+R on macOS)")
end

main()
